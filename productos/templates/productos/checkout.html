{% extends 'productos/base.html' %}

{% block content %}
<h1>Checkout</h1>

{% if carrito.carritoproducto_set.all %}
<div class="productos-grid">
  {% for item in carrito.carritoproducto_set.all %}
    <div class="producto-card">
        {% if item.producto.imagen %}
            <img src="{{ item.producto.imagen.url }}" alt="{{ item.producto.nombre }}">
        {% else %}
            <img src="https://via.placeholder.com/150" alt="Sin imagen">
        {% endif %}
        <h3>{{ item.producto.nombre }}</h3>
        <p>Cantidad: {{ item.cantidad }}</p>
        <p>Precio unitario: ${{ item.producto.precio }}</p>
        <p><strong>Subtotal: ${{ item.subtotal }}</strong></p>
    </div>
  {% endfor %}
</div>

<p>Total a pagar: <strong>${{ total }}</strong></p>

<form id="checkout-form" method="post" action="{% url 'checkout' %}">
    {% csrf_token %}
    <label for="direccion">Dirección de envío:</label>
    <input type="text" name="direccion" id="direccion" required>
    <button type="submit">Finalizar Compra</button>
</form>

<a href="{% url 'ver_carrito' %}">Volver al carrito</a>

<script>
const form = document.getElementById('checkout-form');

form.addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(form);

    try {
        const response = await fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });

        const url = await response.text();
        console.log('URL Mercado Pago:', url); // Para depuración

        if (url.startsWith('http')) {
            // Abrir Mercado Pago en nueva pestaña
            window.open(url, '_blank');

            // Redirigir automáticamente a la página de pago aprobado
            window.location.href = "{% url 'pago_aprobado' %}";
        } else {
            alert('No se pudo generar la preferencia de pago. Intenta de nuevo.');
        }

    } catch (err) {
        console.error("Error en fetch:", err);
        alert("Ocurrió un error inesperado al generar el link de pago.");
    }
});
</script>

{% else %}
<p>No hay productos en el carrito.</p>
<a href="{% url 'lista_productos' %}">Volver a la tienda</a>
{% endif %}

{% endblock %}
