{% extends 'productos/base.html' %}

{% block content %}
<h1>Productos</h1>

<form method="get" class="filtros">
    <input type="text" name="q" placeholder="Buscar producto..." value="{{ request.GET.q|default:'' }}">
    
    <select name="categoria">
        <option value="">Todas las categorías</option>
        {% for cat in categorias %}
            <option value="{{ cat.id }}" {% if request.GET.categoria == cat.id|stringformat:"s" %}selected{% endif %}>
                {{ cat.nombre }}
            </option>
        {% endfor %}
    </select>

    <button type="submit">Filtrar</button>
</form>

<div class="productos-grid">
  {% for producto in productos %}
    <div class="producto-card">

        <!-- Badge ahorro -->
        {% if producto.descuento > 0 %}
        <div class="badge-ahorro">Ahorrás ${{ producto.ahorro|floatformat:0 }}</div>
        {% endif %}

        <!-- Imagen principal -->
        <a href="{% url 'detalle_producto' producto.id %}">
            {% if producto.imagen %}
                <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}">
            {% else %}
                <img src="https://via.placeholder.com/150" alt="Sin imagen">
            {% endif %}
        </a>

        <!-- Nombre -->
        <h3>
            <a href="{% url 'detalle_producto' producto.id %}">
                {{ producto.nombre }}
            </a>
        </h3>

        <p>{{ producto.descripcion|truncatewords:15 }}</p>

        <!-- Precios -->
        {% if producto.descuento > 0 %}
            <p>
                <span class="precio-original" style="text-decoration: line-through; color: #888;">
                    ${{ producto.precio }}
                </span>
                <span class="precio-descuento" style="color: #28a745; font-weight: bold;">
                    ${{ producto.precio_con_descuento|floatformat:2 }}
                </span>
                <span class="badge bg-danger">-{{ producto.descuento }}%</span>
            </p>
        {% else %}
            <p><strong>${{ producto.precio }}</strong></p>
        {% endif %}

        {% if producto.stock == 0 %}
            <p class="sin-stock">Sin Stock</p>
            <a class="btn-carrito disabled">Agregar al carrito</a>
        {% elif producto.stock < 10 %}
            <p class="stock-bajo">Quedan solo {{ producto.stock }} unidades</p>
            <a class="btn-carrito" href="{% url 'agregar_al_carrito' producto.id %}">Agregar al carrito</a>
        {% else %}
            <a class="btn-carrito" href="{% url 'agregar_al_carrito' producto.id %}">Agregar al carrito</a>
        {% endif %}

    </div>
  {% empty %}
    <p>No hay productos disponibles.</p>
  {% endfor %}
</div>

<style>
.badge-ahorro {
    position: absolute;
    top: 10px;
    left: 10px;
    background: #ffc107;
    color: #000;
    font-weight: bold;
    padding: 5px 10px;
    border-radius: 6px;
    font-size: 0.9rem;
    box-shadow: 0px 2px 5px rgba(0,0,0,0.2);
}
.producto-card {
    position: relative;
    border: 1px solid #ddd;
    padding: 15px;
    border-radius: 8px;
    overflow: hidden;
}
</style>
{% endblock %}
